<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js_files/enviroment.js" type="text/javascript"></script>
    <script src="../js_files/config.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <link href="../assets/vendor/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="../assets/img/favicon.png" />
    <title>Login</title>
</head>
<style>
    .swal2-header {
        height: 40px;
        padding: 0 1em;
    }

    .swal2-content {
        padding: 0 15px;
    }

    .swal2-title {
        color: black;
        font-weight: 400;
        font-size: 1.7em;
        line-height: 30px;
        max-width: 360px;
        letter-spacing: 0.05rem;
        font-family: 'Montserrat', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        text-transform: uppercase;
        font-size: 1.25rem;
    }

    body {
        background-image: url("../assets/img/login.png");
        font-family: 'Rubik', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .swal2-container.swal2-backdrop-show,
    .swal2-container.swal2-noanimation {
        background-color: rgba(255, 255, 255, -1);
    }

    .btn-primary {
        color: #FFFFFF !important;
        background-color: #009DA0 !important;
        border-color: #009DA0 !important;
        font-size: 15px;
    }

    .swal2-popup {
        border-radius: 5%;
        width: 25em;
    }

    .swal2-footer {
        margin: 0;
        padding: 15px;
        border-top: 1px solid #afaeae;
    }

    .swal2-actions {
        margin: 0 auto 0;
    }

    .form-control {
        border: 1px solid #a9a9a9;
    }

    .my-validation-message::before {
        display: none;
    }

    .my-validation-message i {
        margin: 0 .4em;
        color: #f27474;
        font-size: 1.4em;
    }
</style>

<body>
    <!-- <span id="message_login">Ingresando ...</span> -->
</body>

</html>
<script>
    var username, perfil;
    Swal.fire({
        title: 'Validando ..',
        allowEscapeKey: false,
        allowOutsideClick: false,
        didOpen: () => {
            swal.showLoading();
        }
    })

    $(document).ready(function () {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const token = urlParams.get('token')

        $.ajax({
            type: 'GET',
            url: `${URL_BACKEND}/login/validar`,
            headers: { 'token': token, "X-Api-Key": API_KEY },
            success: function (response) {
                if (response.success) {
                    username = response.data.username;
                    departamento = response.data.departamento;

                    const departamentos = response.data.departamento;

                    if (departamentos.length === 1 && departamentos[0].perfiles.length === 1) {
                        // Solo un departamento y un perfil → Login directo
                        proceso_login(URL_BACKEND, token, departamentos[0].id ,departamentos[0].perfiles[0].id);

                    } else if (departamentos.length === 1) {
                        // Un solo departamento pero varios perfiles → Seleccionar perfil
                        const unicoDepto = departamentos[0];

                        Swal.fire({
                            title: `Departamento: ${unicoDepto.nombre}`,
                            html: `
                                <div class="row text-left mb-2 pt-4">
                                    <div class="col-md-12">
                                        <label>Perfil</label>
                                        <select class="form-control" id="perfilSelect">
                                            <option value="0" disabled selected>Seleccione</option>
                                            ${unicoDepto.perfiles.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            `,
                            customClass: { validationMessage: 'my-validation-message' },
                            showCloseButton: false,
                            allowOutsideClick: false,
                            confirmButtonText: 'Aceptar',
                            customClass: {
                                confirmButton: 'btn btn-primary btn-raised mr-3'
                            },
                            preConfirm: () => {
                                const perfilId = $('#perfilSelect').val();
                                if (!perfilId || perfilId === "0") {
                                    Swal.showValidationMessage('Debe seleccionar un perfil');
                                    return false;
                                }
                                return perfilId;
                            }
                        }).then(({ isConfirmed, value }) => {
                            if (isConfirmed) proceso_login(URL_BACKEND, token, departamentos[0].id, value);
                        });

                    } else {
                        // Varios departamentos → Seleccionar departamento y luego perfil
                        Swal.fire({
                            title: 'Seleccione su departamento y perfil',
                            html: `
                                <div class="mb-2 pt-4">
                                    <label>Departamento</label>
                                    <select class="form-control" id="departamentoSelect">
                                        <option value="0" disabled selected>Seleccione</option>
                                        ${departamentos.map(d => `<option value="${d.id}">${d.nombre}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label>Perfil</label>
                                    <select class="form-control" id="perfilSelect">
                                        <option value="0" disabled selected>Seleccione un departamento primero</option>
                                    </select>
                                </div>
                            `,
                            customClass: { validationMessage: 'my-validation-message' },
                            showCloseButton: false,
                            allowOutsideClick: false,
                            confirmButtonText: 'Aceptar',
                            customClass: {
                                confirmButton: 'btn btn-primary btn-raised mr-3'
                            },
                            didOpen: () => {
                                $('#departamentoSelect').on('change', function () {
                                    const depId = $(this).val();
                                    const selectedDep = departamentos.find(d => d.id == depId);

                                    $('#perfilSelect').html(`
                                        <option value="0" disabled selected>Seleccione</option>
                                        ${selectedDep.perfiles.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                                    `);

                                    if (selectedDep.perfiles.length === 1) {
                                        $('#perfilSelect').val(selectedDep.perfiles[0].id);
                                    }
                                });
                            },
                            preConfirm: () => {
                                const perfilId = $('#perfilSelect').val();
                                const depId = $('#departamentoSelect').val();
                                if (!depId || depId === "0") return Swal.showValidationMessage('Debe seleccionar un departamento');
                                if (!perfilId || perfilId === "0") return Swal.showValidationMessage('Debe seleccionar un perfil');
                                return perfilId;
                            }
                        }).then(({ isConfirmed, value }) => {
                            if (isConfirmed) proceso_login(URL_BACKEND, token, $('#departamentoSelect').val(), value);
                        });
                    }


                } else {
                    const title = response.mensaje;
                    showMessage({ title });

                    $('.swal2-header').css('height', "70px");
                }
            },
            error: function (request, error) {
                const title = 'No se ha podido iniciar sesión';
                showMessage({ title });

                $('.swal2-header').css('height', "70px");
            }
        });
    });

    function proceso_login(URL_LOGIN, token, id_depto = null ,id_perfil = null) {
        let headers = id_perfil == null ? { 'Authorization': token } : { 'Authorization': token, 'departamento': id_depto, 'perfil': id_perfil }
        $.ajax({
            type: 'GET',
            url: `${URL_BACKEND}/login/system`,
            headers: headers,
            success: function (rs) {
                if (typeof rs != 'object') { rs = JSON.parse(rs); }
                if (rs.response.data.validarResponse.estado == 1) {
                    
                    let cod_perfil = rs.response.data.login[0].perfil;
                    if (cod_perfil != "" && cod_perfil != null) {
                        $('#swal2-title').text('Redireccionando ..');
                        sessionStorage.clear();
                        setTimeout(function () {
                            perfil = rs.response.data.departamento.perfiles;
                            var departamento = {
                                'id': rs.response.data.departamento.id,
                                'nombre': rs.response.data.departamento.nombre,
                                'centro_costo': rs.response.data.departamento.centro_costo,
                                'logo_url': rs.response.data.departamento.logo_url,
                                'descripcion': rs.response.data.departamento.descripcion,
                                'id_facultad': rs.response.data.departamento.id_facultad
                            }
                            var data_usuario = {
                                'id_usuario': rs.response.data.login[0].id_usuario,
                                'nombre': rs.response.data.login[0].nombre,
                                'perfil': rs.response.data.login[0].perfil,
                                'username': rs.response.data.login[0].username,
                                'avatar': rs.response.data.login[0].avatar,
                            }
                            sessionStorage.setItem('usuario', JSON.stringify(data_usuario));
                            sessionStorage.setItem('idUsuario', rs.response.data.login[0].id_usuario);
                            sessionStorage.setItem('access_token', rs.response.data.login[0].access_token);
                            sessionStorage.setItem('perfiles', JSON.stringify(perfil));
                            sessionStorage.setItem('departamento', JSON.stringify(departamento));

                            var now = new Date();
                            now.setMinutes(now.getMinutes() + tiempo_para_expirar);
                            sessionStorage.setItem('session_expirate', now)
                            window.location.replace("../../index.html");
                        }, 100)

                    } else {
                        const title = 'Perfil no seleccionado';
                        showMessage({ title });

                        $('.swal2-header').css('height', "70px");
                    }

                } else {
                    const title = rs.response.data.validarResponse.gloEstado;
                    showMessage({ title });

                    $('.swal2-header').css('height', "70px");
                }
            },
            error: function ({ status }, error) {
                const title = status != 0 ? 'No se ha podido iniciar sesión' : 'El integrador no responde';
                showMessage({ title });
            }
        });
    }

    loadBranchOffices = (branchOfficeList) => {
        let accountant = 0, initialId = null;

        $('#branchOffice').children().remove().end().append($('<option>', {
            value: "0",
            text: "Seleccione"
        }));

        branchOfficeList.forEach(({ id, nombre }) => {
            initialId = accountant == 0 ? id : initialId;
            $('#branchOffice').append($('<option>', { value: id, text: nombre }));
            accountant++;
        });

        if (accountant == 1) $('#branchOffice').val(initialId).trigger('change');
    }

    function volver() {
        window.location.href = "/login.html";
    }

    showMessage = ({ ...params }) => {
        const { title } = params;
        let timerInterval;

        Swal.fire({
            title: `¡${title}!`,
            html: 'Volviendo al inicio de sesión en <b></b> segundos',
            timer: 3000,
            showCloseButton: false,
            showCancelButton: false,
            showConfirmButton: false,
            allowOutsideClick: false,
            timerProgressBar: true,
            allowEscapeKey: false,
            willOpen: () => {
                Swal.showLoading();

                timerInterval = setInterval(() => {
                    const content = Swal.getContent();

                    if (content) {
                        const b = content.querySelector('b');
                        if (b) b.textContent = Math.round(Swal.getTimerLeft() / 1000, 0);
                    }
                }, 100);
            },
            onClose: () => { clearInterval(timerInterval) }
        })
            .then(({ dismiss }) => {
                if (dismiss === Swal.DismissReason.timer) {
                    volver();
                }
            });
    }

</script>